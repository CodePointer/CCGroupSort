# CC_GroupSort ver3.0

标签：练手程序

---

## 废话

分组程序3.0出现了，不出所料，程序的打包时间比编码时间更长。++。  
**3.0相比2.0的主要的改动为**：

- 增加了强制分组选项，不用再手动分组了。强制分组采用贪心法进行分组。
- 分组之后的表格保留了原始表格中的其他信息
- 重构了代码，复合代码规范。。。

**2.0相比1.0的主要改动为**：

- 使用PyQt5增加了Gui
- 从C迁移到了python
- 输入输出文件改为excel，而不是txt
- 使用网络流算法求得最优解

应该能保证大部分情况下的使用吧。  
但在使用的时候请务必认真阅读使用说明。  
如果不需要修改程序的话，使用说明后面的文档都不需要看了。  

---

## 使用说明

### 输入格式
请按照以下要求格式化输入文件：

- 文件格式为xlsx
- 数据请存放在名为 **RawData** 的Sheet中
- 第一行为表头，其余行为数据
- 表头中，需要含有以下字段
    - 姓名
    - 身份
    - 一
    - 二
    - 三
    - 四
    - 五
    - 六
    - 日
- 其中，**一二三四五六日需要相邻**，且从左到右顺序排列。其余字段顺序随意。
- 表头中可以含有其他数据，最终结果会原样保留。
- 身份中，**由'教练'和'学员'组成**，每个教练代表一个教学组。
- 一至日代表训练时间
    - 对于教练，1代表训练时间，其余内容或空代表非训练时间。
    - 对于学员，1代表可用时间，其余内容或空代表不可用时间。

### 界面说明

- Input和Output后面的输入栏，可以手动输入，也可以使用后面的 Open.. 按钮，从文件浏览器中选择。输出文件默认为 Result.xlsx，位置在exe文件目录下。
- 选项 Save group data in different sheets， 如果选中，则最终输出表格时，除去总表之外，还会在不同的sheet中分别输出每个组的信息。建议勾选。
- 选项 Divided into groups anyway，如果选中，则会将时间不合适的学员分组，并标注学员与教练冲突的天数。该建议会尽量减少冲突的天数，为学员分配时间合适的教练。建议勾选。
- 点击Run按钮即可运行。
- 左下角为状态显示。Waiting代表程序空闲，Processing代表程序正在运行。程序运行速度较慢，根据电脑的性能可能需要1-10s不等，请耐心等待。
- 运行结束之后，会有弹窗通知。

### 输出表格说明
输出的表格会增加两项表头：

- 冲突
- 组别

其中，冲突代表冲突的天数，为0-2不等。若未勾选强制分组，则所有学员都保证是无冲的，冲突天数为0。  
组别为教练组的序号。如果勾选了强制分组，则组号从1开始。若未勾选，则有0号组，为无组别，该组中的学员需要手动分组。

---

## 算法说明
以下是简要的算法描述。

### 问题定义
有M个教练组，训练时间每周两次。  
N个学员，可用时间不同，可能满足多个教练组，也可能一个教练组都不满足。  
需要将N个学员放入M个教练组中，尽量满足：  

- 人数大概相等
- 学员时间与教练组时间尽量契合
- 在不满足的情况下，也找到一个建议的教练组

### 贪心法近似求解 (ver1.0)
先将N个学员排序，优先解决时间要求较为严苛的学员。  
对于每个学员，寻找与其合适的教练组。分组遵循以下原则：  

- 有多个教练组满足要求，优先选择人数最少的教练组。
- 若没有教练组两次训练均与学员契合，则退一步，看有一次时间契合的。
- 若没有教练组与学员任何一天契合，则不考虑时间进行分组。

### 网络流法求最优解 (ver2.0)
将N个学员视为N个源点，M个教练组视为M个汇点，学员如果与教练时间契合，则用流量为1的边将二者连起来，从而成为一个多源点、多汇点问题。  
进一步，增加一个总源点，将源点用边长为1的边与学员连接起来。  
增加一个总汇点，用边长为`ceil(N/M)`的边与教练连接起来。  
则该问题转换为网络流法。  
如果存在一种方案使得学员可均匀分配在各个教练组中，则该算法必然能获得该最优解。  
解法使用EdmondsKarp最大流算法。

### 结合求解 (ver3.0)
网络流算法只能获得最优解。但有的时候需要对时间不匹配的学员进行建议分组。故可以在使用网络流算法之后，再使用贪心法对剩余学员进行粗略分组。

---

## 代码结构

### 概述

使用PyQt5进行Gui设计，设计方法用代码，箱布局。  
数据管理使用pandas里面的DataFrame，支持表格的切片、查找，比较方便。  
输入输出则使用现成的接口。  
主要脚本包括以下三个部分。

### GroupSort.py
包含main函数。该模块中还包含了MyExample类，由QWidget派生，实现程序中的gui。

### DataProcess.py
输入、输出函数，以及数据的简单拼接。主要通过xlrd、xlsxwriter来进行xlsx文件的读取与写入。

### NetWorkFlow.py
实现了网络流算法以及最后的贪心法。

---

## 环境配置

使用python3.5。主要的模块为：

- pandas
- xlrd
- xlsxwriter
- PyQt5

可使用`pip install xxx`完成安装。  
另外，pandas原生支持xlsx的读写，默认会安装openpyxl。安装一个xlrd就可以良好的支持pandas里DataFrame数据结构的读入。
但麻烦的是，pyinstaller打包的时候会出错，该打包程序不支持openpyxl，虽然可以成功打包但运行会报错，所以不能使用openpyxl。而且openpyxl还只能写出xls文件，不好，故使用xlsxwriter模块代替。  
PyQt5没有太多的说明文档，只能通过学习Qt5来曲线救国。好在编程风格基本完全一样。

---

## Pyinstaller 打包

完成程序编写后需要打包发布为exe。pyinstaller还支持mac系统的打包，但我手头没有mac无法测试，故不打算继续研究。这里是基于win10平台。

### 安装
使用pip即可安装：

    > pip install pyinstaller

目前只支持Python3.5。

### 使用命令行打包
pyinstaller打包可以说是非常蛋疼，这里有几点需要注意：

 - Python的路径中最好不要有空格（`.spec`文件可解决）
 - PyQt5的dll无法自动导入

所以需要用以下命令行参数：
    
    > pyinstaller -F -w -p <Qt/bin> script.py

这样可以生成一个exe文件。但这样子挺麻烦的，所以又学习了以下`.spec`文件的用法。

### 使用配置文件文件打包

具体的说明参考：[Using Spec Files][1]  
这里只是简单地概括一下。  

使用命令：

    > pyinstaller options script.py

就会生成文件`script.spec`文件，默认目录是和脚本目录一样。

编辑文件。主要要编辑一个部分，也就是包含dll的问题：

    pathex = ['<Qt\bin>', './']

然后就可以直接运行：

    > pyinstaller script.spec
    
即可。

  [1]: https://pythonhosted.org/PyInstaller/spec-files.html#using-spec-files